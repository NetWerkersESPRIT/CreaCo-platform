<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8"/>
		<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
		<link rel="apple-touch-icon" sizes="76x76" href="{{ asset('assets/img/apple-icon.png') }}"/>
		<link rel="icon" type="image/png" href="{{ asset('assets/img/favicon.png') }}"/>
		<title>
			{% block title %}Event Management
			{% endblock %}
		</title>
		<!--     Fonts and icons     -->
		<link
		href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700" rel="stylesheet"/>

		<!-- ‚úÖ ADDED: Font Awesome CSS (fix icons not showing) -->
		<link
		rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

		<!-- Font Awesome Icons -->
		<script src="https://kit.fontawesome.com/42d5adcbca.js" crossorigin="anonymous"></script>
		<!-- Nucleo Icons -->
		<link href="{{ asset('assets/css/nucleo-icons.css') }}" rel="stylesheet"/>
		<link
		href="{{ asset('assets/css/nucleo-svg.css') }}" rel="stylesheet"/>
		<!-- Popper -->
		<script src="https://unpkg.com/@popperjs/core@2"></script>
		<!-- Main Styling -->
		<link href="{{ asset('assets/css/soft-ui-dashboard-tailwind.css') }}?v=1.0.5" rel="stylesheet"/> {% block stylesheets %}{% endblock %}
		</head>

		<body class="m-0 font-sans antialiased font-normal text-base leading-default bg-gray-50 text-slate-500">
			{% include 'partials/_sidebar.html.twig' %}

			<main
				class="ease-soft-in-out xl:ml-68.5 relative h-full max-h-screen rounded-xl transition-all duration-200">
				<!-- Navbar -->
				{% include 'partials/_navbar.html.twig' %}

				<div
					class="w-full px-6 py-6 mx-auto">

					{# ‚úÖ SUCCESS (Green) #}
					{% for message in app.flashes('success') %}
						<div class="relative w-full p-4 mb-4 text-white bg-gradient-to-tl from-green-600 to-lime-400 rounded-lg shadow-soft-xl">
							{{ message }}
						</div>
					{% endfor %}

					{# ‚ö†Ô∏è WARNING (Yellow/Red) #}
					{% for message in app.flashes('warning') %}
						<div class="relative w-full p-4 mb-4 text-white bg-gradient-to-tl from-red-500 to-yellow-400 rounded-lg shadow-soft-xl">
							{{ message }}
						</div>
					{% endfor %}

					{# ‚ö†Ô∏è DANGER / REFUSAL (Orange/Yellow) #}
					{% for message in app.flashes('danger') %}
						<div class="relative w-full p-4 mb-4 text-white bg-gradient-to-tl from-orange-500 to-yellow-400 rounded-lg shadow-soft-xl">
							{{ message }}
						</div>
					{% endfor %}

					{# üöÄ POST APPROVED (Green Strong Pulse) #}
					{% for message in app.flashes('post_approved') %}
						<div class="relative w-full p-6 mb-6 text-white bg-gradient-to-tl from-green-600 to-lime-400 rounded-lg shadow-soft-xl border-0 font-bold text-center animate-pulse">
							<i class="fas fa-check-circle mr-2"></i>
							{{ message }}
						</div>
					{% endfor %}

					{# üõë POST REFUSED (Red/Orange Strong Pulse) #}
					{% for message in app.flashes('post_refused') %}
						<div class="relative w-full p-6 mb-6 text-white bg-gradient-to-tl from-red-600 to-orange-400 rounded-lg shadow-soft-xl border-0 font-bold text-center animate-pulse">
							<i class="fas fa-exclamation-triangle mr-2"></i>
							{{ message }}
						</div>
					{% endfor %}

					{% block body %}{% endblock %}

				</div>

			</main>

			{% block javascripts %}
				<script src="{{ asset('assets/js/soft-ui-dashboard-tailwind.js') }}?v=1.0.5" async></script>
				<script>
					document.addEventListener('DOMContentLoaded', function () {
const badge = document.getElementById('notif-badge');
const notifContainer = document.getElementById('notif-list-container');
const dropdownTrigger = document.querySelector('[dropdown-trigger]');

// Function to update unread count
async function updateUnreadCount() {
try {
const response = await fetch('/notifications/api/unread-count');
if (response.ok) {
const data = await response.json();
if (data.count > 0) {
badge.textContent = data.count > 9 ? '9+' : data.count;
badge.classList.remove('hidden');
} else {
badge.classList.add('hidden');
}
}
} catch (e) {
console.error('Error polling notifications', e);
}
}

// Initial call and set interval
if (badge) {
updateUnreadCount();
setInterval(updateUnreadCount, 5000); // Every 5 seconds
}

// Load list when clicking the bell
if (dropdownTrigger) {
dropdownTrigger.addEventListener('click', async function () { // Small delay to let dropdown appear
setTimeout(async () => {
try {
const response = await fetch('/notifications/api');
if (response.ok) {
const notifications = await response.json();
if (notifications.length > 0) {
notifContainer.innerHTML = '';
notifications.forEach(n => {
const item = document.createElement('div');
item.className = `px-4 py-3 border-b border-gray-50 hover:bg-slate-50 transition-colors cursor-pointer relative bg-fuchsia-50/30`;
item.innerHTML = `
														<div class="no-underline block" onclick="handleNotifClick(${
n.id
}, '${
n.targetUrl || '#'
}')">
															<p class="text-xs font-bold text-slate-700 mb-1">${
n.message
}</p>
															<div class="flex items-center justify-between">
																<span class="text-[10px] text-slate-400 italic">${
n.createdAt
}</span>
																<span class="w-1.5 h-1.5 bg-fuchsia-500 rounded-full"></span>
															</div>
														</div>
													`;
notifContainer.appendChild(item);
});
} else {
notifContainer.innerHTML = '<div class="px-4 py-3 text-center text-xs text-slate-400 italic">Aucune notification</div>';
}
}
} catch (e) {
console.error('Error loading notifications', e);
}
}, 100);
});
}

// Global function to mark as read and redirect
window.handleNotifClick = async function (id, url) {
try {
await fetch (`/notifications/api/${id}/read`, {method: 'POST'});
if (url && url !== '#' && url !== 'javascript:;') {
window.location.href = url;
}
} catch (e) {
console.error('Error handling notif click', e);
if (url && url !== '#' && url !== 'javascript:;') {
window.location.href = url;
}
}
};

window.markAsRead = async function (id) {
try {
await fetch (`/notifications/api/${id}/read`, {method: 'POST'});
} catch (e) {
console.error('Error marking as read', e);
}
};
});
				</script>
			{% endblock %}
		</body>
	</html>
