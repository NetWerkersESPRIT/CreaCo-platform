{% extends 'base.html.twig' %}

{% block title %}Mes Notifications
{% endblock %}

{% block body %}
	<div class="flex flex-wrap -mx-3 items-center justify-center py-8">
		<div class="w-full max-w-full px-3 lg:w-8/12 mx-auto">
			<div class="relative flex flex-col min-w-0 break-words bg-white border-0 shadow-soft-xl rounded-2xl bg-clip-border">
				<div class="p-6 pb-0 mb-0 bg-white border-b-0 rounded-t-2xl">
					<div class="flex flex-wrap -mx-3">
						<div class="flex items-center w-full max-w-full px-3 shrink-0 md:w-8/12 md:flex-none">
							<h6 class="mb-0 font-bold">Toutes mes Notifications</h6>
						</div>
					</div>
				</div>
				<div class="flex-auto p-6">
					<ul class="flex flex-col pl-0 mb-0 rounded-lg">
						{% for notification in notifications %}
							<li class="relative flex p-4 mb-3 border-0 rounded-2xl transition-all duration-300 {{ notification.isRead ? 'bg-gray-50 opacity-60' : 'bg-white shadow-soft-sm border border-fuchsia-50' }}" id="notif-{{ notification.id }}">
								<div class="flex flex-col w-full">
									<div class="flex items-start justify-between">
										<div class="flex items-center">
											<div class="w-10 h-10 rounded-xl bg-gradient-to-tl from-purple-700 to-pink-500 shadow-soft-md flex items-center justify-center mr-4 shrink-0">
												<i class="fas {{ notification.type == 'MESSAGE' ? 'fa-envelope' : 'fa-bell' }} text-white text-xs"></i>
											</div>
											<div>
												<p class="mb-0 text-sm font-bold text-slate-700 leading-tight">{{ notification.message }}</p>
												<p class="mb-0 text-xxs text-slate-400 font-semibold uppercase mt-1">
													<i class="far fa-clock mr-1"></i>
													{{ notification.createdAt|date('d M Y H:i') }}
												</p>
											</div>
										</div>
										<div class="flex flex-col items-end gap-2 ml-4">
											{% if not notification.isRead %}
												<span class="badge-new bg-gradient-to-tl from-purple-700 to-pink-500 text-white text-[10px] font-bold px-2.5 py-1 rounded-lg uppercase tracking-wider shadow-soft-xs">Nouveau</span>
											{% endif %}
										</div>
									</div>
									<div class="flex items-center justify-between mt-4">
										<div>
											{% if notification.targetUrl %}
												<a href="{{ notification.targetUrl }}" class="text-xs font-bold text-purple-700 hover:text-pink-500 transition-all uppercase no-underline flex items-center gap-1" onclick="markAsRead({{ notification.id }})">
													<i class="fas fa-arrow-right text-[10px]"></i>
													Voir les d√©tails
												</a>
											{% endif %}
										</div>
										{% if not notification.isRead %}
											<button onclick="markAsRead({{ notification.id }}, this)" class="btn-mark-read text-[10px] font-bold text-slate-400 hover:text-purple-700 transition-all uppercase border-0 bg-transparent cursor-pointer tracking-wide flex items-center gap-1">
												<i class="fas fa-check"></i>
												Marquer comme lu
											</button>
										{% endif %}
									</div>
								</div>
							</li>
						{% else %}
							<div class="text-center py-24 opacity-30">
								<i class="fas fa-bell-slash text-6xl mb-4 text-slate-300"></i>
								<p class="text-lg font-bold text-slate-500 uppercase tracking-wider">Aucune notification</p>
							</div>
						{% endfor %}
					</ul>
				</div>
			</div>
		</div>
	</div>

	<script>
		async function markAsRead(id, btn) {
try {
const response = await fetch (`/notifications/api/${id}/read`, {method: 'POST'});
if (response.ok) {
const li = document.getElementById (`notif-${id}`);
if (li) {
li.classList.remove('bg-white', 'shadow-soft-sm', 'border', 'border-fuchsia-50');
li.classList.add('bg-gray-50', 'opacity-60');

const badge = li.querySelector('.badge-new');
if (badge) 
badge.classList.add('hidden');


// If user clicked the button, remove it
if (btn) {
btn.classList.add('hidden');
} else { // If they clicked the link, the button should also disappear if they come back
const actionBtn = li.querySelector('.btn-mark-read');
if (actionBtn) 
actionBtn.classList.add('hidden');

}
}
}
} catch (e) {
console.error('Error marking as read', e);
}
}
	</script>
{% endblock %}
